<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow,noarchive" />
  <title>ATS Site Report</title>
  <link rel="stylesheet" href="/admin/admin-layout.css" />
</head>

<body>
  <header class="ats-header">
    <div class="inner">
      <div class="ats-brand">
        <a href="/admin/"><img src="/assets/images/logo.png" alt="About To Shine Cleaning logo"></a>
      </div>
      <nav class="ats-nav">
        <a href="/admin/">Admin</a>
        <a href="/admin/estimator/">Estimator</a>
        <a href="/admin/payroll/">Payroll</a>
        <a href="/admin/analytics.html" aria-current="page">Site Report</a>
      </nav>
    </div>
    <div class="ats-divider"></div>
  </header>

  <main class="ats-wrap">

    <section class="ats-card">
      <h2 style="margin:0 0 6px">Site Report</h2>
      <div class="small">
        GA4 overview pulled via Apps Script (JSONP). Uses <code>route=...</code> endpoints.
      </div>
      <div style="height:12px"></div>

      <div class="ats-grid">
        <div class="ats-card">
          <div class="small">New vs Returning (Active Users)</div>
          <div id="newReturning" style="font-size:22px;font-weight:800">Loadingâ€¦</div>
        </div>

        <div class="ats-card">
          <div class="small">Totals (Last 30 days)</div>
          <div id="totals" style="font-size:22px;font-weight:800">Loadingâ€¦</div>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="ats-card">
        <div class="small">Sessions by Source / Medium</div>
        <div style="height:10px"></div>
        <table>
          <thead>
            <tr><th>Source</th><th>Medium</th><th>Sessions</th><th>Active Users</th></tr>
          </thead>
          <tbody id="srcTable"></tbody>
        </table>
      </div>

      <p class="small" style="margin-top:12px">
        Setup: edit <code>/admin/analytics.html</code> and paste your Apps Script Web App URL into <code>GA_API_URL</code>.
      </p>

      <p class="small" id="debugLine" style="margin-top:8px;opacity:.85"></p>
    </section>

    <script>
      // ðŸ”’ Require Admin Panel auth (set by /admin/admin.js)
      const AUTH_STORAGE  = "ats_admin_auth_v1";        // sessionStorage JSON
      const TOKEN_STORAGE = "ats_admin_token_v1";       // sessionStorage token
      const TOKEN_LOCAL   = "ats_admin_token_local_v1"; // localStorage token

      function readJson_(k){
        try{ return JSON.parse(sessionStorage.getItem(k) || ""); }catch(e){ return null; }
      }
      function loadAnyToken_(){
        try{ const s=(sessionStorage.getItem(TOKEN_STORAGE)||"").trim(); if(s) return s; }catch(e){}
        try{ const l=(localStorage.getItem(TOKEN_LOCAL)||"").trim(); if(l) return l; }catch(e){}
        return "";
      }
      function requireAdminAuth_(){
        const statusEl = document.getElementById("status");
        const whoEl = document.getElementById("who");
        const auth = readJson_(AUTH_STORAGE);
        const token = loadAnyToken_();

        if (!auth || auth.ok !== true || !auth.employeeId || !token) {
          if (statusEl) statusEl.textContent = "Admin sign-in required. Redirecting to /admin/â€¦";
          setTimeout(() => { window.location.href = "/admin/"; }, 600);
          return null;
        }

        if (whoEl) whoEl.textContent = `${auth.employeeId} â€¢ ${auth.employeeName || auth.employeeId}`;
        return auth;
      }

      const _AUTH = requireAdminAuth_();
      // âœ… MUST be your Apps Script Web App URL that ends in /exec
      const GA_API_URL = "https://script.google.com/macros/s/AKfycbwebnc7k-OlEuOKLc_WgGalVeFISPfsTniFdSIhfhi7vra-ALZcbNGZcj7Qti3nFklH/exec";
      const RANGE = "30daysAgo"; // matches your Code.gs supported range format

      function jsonp(url){
        return new Promise((resolve,reject)=>{
          const cb="cb_"+Math.random().toString(36).slice(2);
          const s=document.createElement("script");

          window[cb]=(data)=>{ 
            try { resolve(data); } finally { 
              try { delete window[cb]; } catch(e) {}
              try { s.remove(); } catch(e) {}
            }
          };

          s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
          s.onerror = () => {
            try { delete window[cb]; } catch(e) {}
            try { s.remove(); } catch(e) {}
            reject(new Error("JSONP failed: " + url));
          };

          document.body.appendChild(s);
        });
      }

      function routeUrl(route){
        const p = new URLSearchParams();
        p.set("route", route);
        p.set("range", RANGE);
        return GA_API_URL + "?" + p.toString();
      }

      function fmt(n){ return Number(n||0).toLocaleString(); }

      async function load(){
        const nrEl = document.getElementById("newReturning");
        const totalsEl = document.getElementById("totals");
        const tbody = document.getElementById("srcTable");
        const dbg = document.getElementById("debugLine");

        if(!GA_API_URL || GA_API_URL.includes("PASTE_")){
          nrEl.textContent = "Missing GA_API_URL";
          totalsEl.textContent = "â€”";
          return;
        }

        if (dbg) dbg.textContent = "Loading from: " + GA_API_URL;

        // 1) New vs Returning
        const nr = await jsonp(routeUrl("ga_new_returning"));
        if(!nr || !nr.ok){
          throw new Error(nr?.error || "ga_new_returning failed");
        }

        const nrRows = nr?.res?.rows || [];
        const map = { new: 0, returning: 0 };
        nrRows.forEach(r=>{
          const k = (r?.dimensionValues?.[0]?.value || "").toLowerCase();
          const v = Number(r?.metricValues?.[0]?.value || 0);
          if (k === "new") map.new = v;
          if (k === "returning") map.returning = v;
        });
        nrEl.textContent = `New: ${fmt(map.new)} â€¢ Returning: ${fmt(map.returning)}`;

        // 2) Totals (sum daily)
        const daily = await jsonp(routeUrl("ga_overview_daily"));
        if(!daily || !daily.ok){
          throw new Error(daily?.error || "ga_overview_daily failed");
        }

        const drows = daily?.res?.rows || [];
        let users=0, sessions=0, views=0;
        drows.forEach(r=>{
          users += Number(r?.metricValues?.[0]?.value || 0);
          sessions += Number(r?.metricValues?.[1]?.value || 0);
          views += Number(r?.metricValues?.[2]?.value || 0);
        });
        totalsEl.textContent = `Users: ${fmt(users)} â€¢ Sessions: ${fmt(sessions)} â€¢ Views: ${fmt(views)}`;

        // 3) Source / Medium
        const sm = await jsonp(routeUrl("ga_source_medium"));
        if(!sm || !sm.ok){
          throw new Error(sm?.error || "ga_source_medium failed");
        }

        const srows = sm?.res?.rows || [];
        tbody.innerHTML = "";

        srows.forEach(r=>{
          const source = r?.dimensionValues?.[0]?.value || "";
          const medium = r?.dimensionValues?.[1]?.value || "";
          const sess = Number(r?.metricValues?.[0]?.value || 0);
          const au = Number(r?.metricValues?.[1]?.value || 0);
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${source}</td><td>${medium}</td><td>${fmt(sess)}</td><td>${fmt(au)}</td>`;
          tbody.appendChild(tr);
        });

        if (srows.length === 0){
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="4" class="small">No data returned yet.</td>`;
          tbody.appendChild(tr);
        }
      }

      if (_AUTH) {
        load().catch(err=>{
          console.error(err);
          document.getElementById("newReturning").textContent = "Load failed (check Apps Script URL + permissions).";
          document.getElementById("totals").textContent = "â€”";
        });
      }
    </script>

  </main>

  <footer class="ats-footer">
    <div class="ats-divider"></div>
    <div class="inner">
      About To Shine Cleaning â€¢ Internal Admin â€¢ Test Environment
    </div>
  </footer>
</body>
</html>
