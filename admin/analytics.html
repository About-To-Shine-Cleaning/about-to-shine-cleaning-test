<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow,noarchive" />
  <title>ATS Site Report</title>
  <link rel="stylesheet" href="/admin/admin-layout.css" />
</head>

<body>
  <header class="ats-header">
    <div class="inner">
      <div class="ats-brand">
        <a href="/admin/"><img src="/assets/images/logo.png" alt="About To Shine Cleaning logo"></a>
      </div>
      <nav class="ats-nav">
        <a href="/admin/">Admin</a>
        <a href="/admin/estimator/">Estimator</a>
        <a href="/admin/payroll/">Payroll</a>
        <a href="/admin/analytics.html" aria-current="page">Site Report</a>
      </nav>
    </div>
    <div class="ats-divider"></div>
  </header>

  <main class="ats-wrap">

    <section class="ats-card">
      <h2 style="margin:0 0 6px">Site Report</h2>
      <div class="small">GA4 overview pulled via Apps Script (JSONP). Paste your Apps Script Web App <code>/exec</code> URL below.</div>
      <div style="height:12px"></div>

      <div class="ats-grid">
        <div class="ats-card">
          <div class="small">New vs Returning (Active Users)</div>
          <div id="newReturning" style="font-size:22px;font-weight:800">Loading…</div>
        </div>

        <div class="ats-card">
          <div class="small">Totals (Last 30 days)</div>
          <div id="totals" style="font-size:22px;font-weight:800">Loading…</div>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="ats-card">
        <div class="small">Sessions by Source / Medium</div>
        <div style="height:10px"></div>
        <table>
          <thead>
            <tr><th>Source</th><th>Medium</th><th>Sessions</th><th>Active Users</th></tr>
          </thead>
          <tbody id="srcTable"></tbody>
        </table>
      </div>

      <p class="small" style="margin-top:12px">
        Setup: edit <code>/admin/analytics.html</code> and paste your Apps Script Web App URL into <code>GA_API_URL</code>.
      </p>
    </section>

    <script>
      // ✅ MUST be your Apps Script Web App URL that ends in /exec
      const GA_API_URL = "https://script.google.com/macros/s/AKfycbypP0QPCfgX5LGUhEGol2RuOOYzRO_Nzdish8xRaPy49a0httlNJmNT2x59LvrM1RR-/exec";

      function jsonp(url){
        return new Promise((resolve,reject)=>{
          const cb="cb_"+Math.random().toString(36).slice(2);
          const s=document.createElement("script");
          window[cb]=(data)=>{ 
            try { resolve(data); } finally { 
              try { delete window[cb]; } catch(e) {}
              try { s.remove(); } catch(e) {}
            }
          };
          s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
          s.onerror = () => {
            try { delete window[cb]; } catch(e) {}
            try { s.remove(); } catch(e) {}
            reject(new Error("JSONP failed"));
          };
          document.body.appendChild(s);
        });
      }

      function apiUrl(action){
        const p = new URLSearchParams();
        p.set("action", action);
        return GA_API_URL + "?" + p.toString();
      }

      function fmt(n){ return Number(n||0).toLocaleString(); }

      async function load(){
        const nrEl = document.getElementById("newReturning");
        const totalsEl = document.getElementById("totals");
        const tbody = document.getElementById("srcTable");

        if(!GA_API_URL || GA_API_URL.includes("PASTE_")){
          nrEl.textContent = "Missing GA_API_URL";
          totalsEl.textContent = "—";
          return;
        }

        // 1) Overview (totals + new vs returning)
        const ov = await jsonp(apiUrl("overview"));
        if(!ov || !ov.ok){
          throw new Error(ov?.error || "Overview failed");
        }

        const breakdown = ov.newVsReturning || [];
        const map = {};
        breakdown.forEach(x => map[(x.label||"").toLowerCase()] = Number(x.activeUsers||0));

        nrEl.textContent = `New: ${fmt(map["new"])} • Returning: ${fmt(map["returning"])}`;

        const t = ov.totals || {};
        totalsEl.textContent = `Users: ${fmt(t.activeUsers)} • Sessions: ${fmt(t.sessions)} • Views: ${fmt(t.pageViews)}`;

        // 2) Source/Medium table
        const sm = await jsonp(apiUrl("sourceMedium"));
        if(!sm || !sm.ok){
          throw new Error(sm?.error || "Source/Medium failed");
        }

        tbody.innerHTML = "";
        (sm.rows || []).forEach(r=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.source||""}</td><td>${r.medium||""}</td><td>${fmt(r.sessions)}</td><td>${fmt(r.activeUsers)}</td>`;
          tbody.appendChild(tr);
        });

        if((sm.rows||[]).length === 0){
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="4" class="small">No data returned yet.</td>`;
          tbody.appendChild(tr);
        }
      }

      load().catch(err=>{
        console.error(err);
        document.getElementById("newReturning").textContent = "Load failed (check Apps Script URL + permissions).";
        document.getElementById("totals").textContent = "—";
      });
    </script>

  </main>

  <footer class="ats-footer">
    <div class="ats-divider"></div>
    <div class="inner">
      About To Shine Cleaning • Internal Admin • Test Environment
    </div>
  </footer>
</body>
</html>
